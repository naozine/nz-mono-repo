{{define "column_selector.html"}}
{{if eq .AnalysisType "simple"}}
<!-- 単純集計の列選択 -->
<div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
        集計列
    </label>
    <select name="column" id="column-select"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required>
        <option value="">列を選択してください</option>
        {{range .Columns}}
        <option value="{{.Index}}"
                data-multi="{{.IsMulti}}"
                data-derived="{{.IsDerived}}">
            {{.Index}}. {{.Name}}
            {{if .IsDerived}}[派生列]{{else if .IsMulti}}[複数回答]{{end}}
        </option>
        {{end}}
    </select>

    <!-- 複数回答分割オプション -->
    <div id="split-option" class="mt-3" style="display:none;">
        <label class="flex items-center">
            <input type="checkbox" name="split" value="true" class="mr-2">
            <span class="text-sm text-gray-700">複数回答として分割する</span>
        </label>
    </div>

    <script>
        // 列選択時に複数回答の場合は分割オプションを表示
        document.getElementById('column-select').addEventListener('change', function(e) {
            const selected = e.target.options[e.target.selectedIndex];
            const isMulti = selected.dataset.multi === 'true';
            const isDerived = selected.dataset.derived === 'true';
            const splitOption = document.getElementById('split-option');

            // 派生列でなく、複数回答の場合のみ表示
            if (isMulti && !isDerived) {
                splitOption.style.display = 'block';
            } else {
                splitOption.style.display = 'none';
            }
        });
    </script>
</div>
{{else}}
<!-- クロス集計の列選択 -->
<div class="space-y-4">
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
            列を選択
        </label>
        <div class="border border-gray-300 rounded-lg overflow-hidden">
            <div class="max-h-80 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">列名</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">X軸<br>(行)</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Y軸<br>(列)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {{range .Columns}}
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm text-gray-900">
                                {{.Index}}. {{.Name}}
                                {{if .IsDerived}}<span class="text-xs text-blue-600">[派生列]</span>{{else if .IsMulti}}<span class="text-xs text-purple-600">[複数回答]</span>{{end}}
                            </td>
                            <td class="px-3 py-2 text-center">
                                <input type="radio" name="x_column" value="{{.Index}}"
                                       class="w-4 h-4 text-blue-600 focus:ring-blue-500"
                                       data-multi="{{.IsMulti}}" data-derived="{{.IsDerived}}"
                                       onchange="updateSplitOptions()" required>
                            </td>
                            <td class="px-3 py-2 text-center">
                                <input type="radio" name="y_column" value="{{.Index}}"
                                       class="w-4 h-4 text-blue-600 focus:ring-blue-500"
                                       data-multi="{{.IsMulti}}" data-derived="{{.IsDerived}}"
                                       onchange="updateSplitOptions()" required>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 軸入れ替えボタン -->
    <div class="flex justify-center">
        <button type="button" id="swap-axes-btn"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 rounded-lg transition duration-200"
                onclick="swapAxes()">
            ⇄ 軸を入れ替え
        </button>
    </div>

    <!-- 複数回答分割オプション -->
    <div id="split-x-option" class="hidden">
        <label class="flex items-center">
            <input type="checkbox" name="split_x" value="true" class="mr-2">
            <span class="text-sm text-gray-700">X軸を複数回答として分割する</span>
        </label>
    </div>

    <div id="split-y-option" class="hidden">
        <label class="flex items-center">
            <input type="checkbox" name="split_y" value="true" class="mr-2">
            <span class="text-sm text-gray-700">Y軸を複数回答として分割する</span>
        </label>
    </div>

    <script>
        // 分割オプションの表示を更新
        function updateSplitOptions() {
            const xRadio = document.querySelector('input[name="x_column"]:checked');
            const yRadio = document.querySelector('input[name="y_column"]:checked');
            const splitXOption = document.getElementById('split-x-option');
            const splitYOption = document.getElementById('split-y-option');
            const splitXCheckbox = document.querySelector('input[name="split_x"]');
            const splitYCheckbox = document.querySelector('input[name="split_y"]');

            // X軸の分割オプション
            if (xRadio) {
                const isMulti = xRadio.dataset.multi === 'true';
                const isDerived = xRadio.dataset.derived === 'true';
                if (isMulti && !isDerived) {
                    splitXOption.classList.remove('hidden');
                } else {
                    splitXOption.classList.add('hidden');
                    if (splitXCheckbox) splitXCheckbox.checked = false;
                }
            } else {
                splitXOption.classList.add('hidden');
                if (splitXCheckbox) splitXCheckbox.checked = false;
            }

            // Y軸の分割オプション
            if (yRadio) {
                const isMulti = yRadio.dataset.multi === 'true';
                const isDerived = yRadio.dataset.derived === 'true';
                if (isMulti && !isDerived) {
                    splitYOption.classList.remove('hidden');
                } else {
                    splitYOption.classList.add('hidden');
                    if (splitYCheckbox) splitYCheckbox.checked = false;
                }
            } else {
                splitYOption.classList.add('hidden');
                if (splitYCheckbox) splitYCheckbox.checked = false;
            }
        }

        // 軸を入れ替える関数
        function swapAxes() {
            const xRadio = document.querySelector('input[name="x_column"]:checked');
            const yRadio = document.querySelector('input[name="y_column"]:checked');
            const splitXCheckbox = document.querySelector('input[name="split_x"]');
            const splitYCheckbox = document.querySelector('input[name="split_y"]');

            if (!xRadio || !yRadio) {
                return; // 両方選択されていない場合は何もしない
            }

            const xValue = xRadio.value;
            const yValue = yRadio.value;

            // ラジオボタンの選択を入れ替え
            xRadio.checked = false;
            yRadio.checked = false;

            const newXRadio = document.querySelector(`input[name="x_column"][value="${yValue}"]`);
            const newYRadio = document.querySelector(`input[name="y_column"][value="${xValue}"]`);

            if (newXRadio) newXRadio.checked = true;
            if (newYRadio) newYRadio.checked = true;

            // チェックボックスの状態を入れ替え
            if (splitXCheckbox && splitYCheckbox) {
                const xChecked = splitXCheckbox.checked;
                const yChecked = splitYCheckbox.checked;
                splitXCheckbox.checked = yChecked;
                splitYCheckbox.checked = xChecked;
            }

            // 分割オプションの表示を更新
            updateSplitOptions();
        }

        // 初期化時に分割オプションを更新
        document.addEventListener('DOMContentLoaded', function() {
            updateSplitOptions();
        });
    </script>
</div>
{{end}}
{{end}}
