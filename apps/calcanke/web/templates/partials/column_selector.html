{{define "column_selector.html"}}
{{if eq .AnalysisType "simple"}}
<!-- 単純集計の列選択 -->
<div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
        集計列
    </label>
    <select name="column" id="column-select"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required>
        <option value="">列を選択してください</option>
        {{range .Columns}}
        <option value="{{.Index}}"
                data-multi="{{.IsMulti}}"
                data-derived="{{.IsDerived}}">
            {{.Index}}. {{.Name}}
            {{if .IsDerived}}[派生列]{{else if .IsMulti}}[複数回答]{{end}}
        </option>
        {{end}}
    </select>

    <!-- 複数回答分割オプション -->
    <div id="split-option" class="mt-3" style="display:none;">
        <label class="flex items-center">
            <input type="checkbox" name="split" value="true" class="mr-2">
            <span class="text-sm text-gray-700">複数回答として分割する</span>
        </label>
    </div>

    <script>
        // 列選択時に複数回答の場合は分割オプションを表示
        document.getElementById('column-select').addEventListener('change', function(e) {
            const selected = e.target.options[e.target.selectedIndex];
            const isMulti = selected.dataset.multi === 'true';
            const isDerived = selected.dataset.derived === 'true';
            const splitOption = document.getElementById('split-option');

            // 派生列でなく、複数回答の場合のみ表示
            if (isMulti && !isDerived) {
                splitOption.style.display = 'block';
            } else {
                splitOption.style.display = 'none';
            }
        });
    </script>
</div>
{{else}}
<!-- クロス集計の列選択 -->
<div class="space-y-4">
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
            X軸（行）
        </label>
        <select name="x_column" id="x-column-select"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required>
            <option value="">列を選択してください</option>
            {{range .Columns}}
            <option value="{{.Index}}"
                    data-multi="{{.IsMulti}}"
                    data-derived="{{.IsDerived}}">
                {{.Index}}. {{.Name}}
                {{if .IsDerived}}[派生列]{{else if .IsMulti}}[複数回答]{{end}}
            </option>
            {{end}}
        </select>

        <!-- X軸の複数回答分割オプション -->
        <div id="split-x-option" class="mt-2" style="display:none;">
            <label class="flex items-center">
                <input type="checkbox" name="split_x" value="true" class="mr-2">
                <span class="text-sm text-gray-700">X軸を複数回答として分割する</span>
            </label>
        </div>
    </div>

    <!-- 軸入れ替えボタン -->
    <div class="flex justify-center">
        <button type="button" id="swap-axes-btn"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 rounded-lg transition duration-200"
                onclick="swapAxes()">
            ⇄ 軸を入れ替え
        </button>
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Y軸（列）
        </label>
        <select name="y_column" id="y-column-select"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required>
            <option value="">列を選択してください</option>
            {{range .Columns}}
            <option value="{{.Index}}"
                    data-multi="{{.IsMulti}}"
                    data-derived="{{.IsDerived}}">
                {{.Index}}. {{.Name}}
                {{if .IsDerived}}[派生列]{{else if .IsMulti}}[複数回答]{{end}}
            </option>
            {{end}}
        </select>

        <!-- Y軸の複数回答分割オプション -->
        <div id="split-y-option" class="mt-2" style="display:none;">
            <label class="flex items-center">
                <input type="checkbox" name="split_y" value="true" class="mr-2">
                <span class="text-sm text-gray-700">Y軸を複数回答として分割する</span>
            </label>
        </div>
    </div>

    <script>
        // 軸を入れ替える関数
        function swapAxes() {
            const xSelect = document.getElementById('x-column-select');
            const ySelect = document.getElementById('y-column-select');
            const xSplitCheckbox = document.querySelector('input[name="split_x"]');
            const ySplitCheckbox = document.querySelector('input[name="split_y"]');

            // 選択値を入れ替え
            const xValue = xSelect.value;
            const yValue = ySelect.value;
            xSelect.value = yValue;
            ySelect.value = xValue;

            // チェックボックスの状態を入れ替え
            if (xSplitCheckbox && ySplitCheckbox) {
                const xChecked = xSplitCheckbox.checked;
                const yChecked = ySplitCheckbox.checked;
                xSplitCheckbox.checked = yChecked;
                ySplitCheckbox.checked = xChecked;
            }

            // changeイベントを発火して、分割オプションの表示を更新
            xSelect.dispatchEvent(new Event('change'));
            ySelect.dispatchEvent(new Event('change'));
        }

        // X軸選択時
        document.getElementById('x-column-select').addEventListener('change', function(e) {
            const selected = e.target.options[e.target.selectedIndex];
            const isMulti = selected.dataset.multi === 'true';
            const isDerived = selected.dataset.derived === 'true';
            const splitOption = document.getElementById('split-x-option');

            if (isMulti && !isDerived) {
                splitOption.style.display = 'block';
            } else {
                splitOption.style.display = 'none';
            }
        });

        // Y軸選択時
        document.getElementById('y-column-select').addEventListener('change', function(e) {
            const selected = e.target.options[e.target.selectedIndex];
            const isMulti = selected.dataset.multi === 'true';
            const isDerived = selected.dataset.derived === 'true';
            const splitOption = document.getElementById('split-y-option');

            if (isMulti && !isDerived) {
                splitOption.style.display = 'block';
            } else {
                splitOption.style.display = 'none';
            }
        });
    </script>
</div>
{{end}}
{{end}}
