# 実装計画

## アーキテクチャ概要

```
┌──────────────┐
│   main.go    │  コマンドエントリーポイント
└──────┬───────┘
       │
       ├─ import   (既存機能)
       ├─ columns  (新規)
       └─ analyze  (新規: 対話型分析)
              │
              ↓
       ┌─────────────────┐
       │  Interactive UI  │  survey で実装
       └────────┬─────────┘
                │
                ↓
       ┌─────────────────┐
       │    Analyzer      │  DuckDB操作・集計ロジック
       └────────┬─────────┘
                │
                ↓
       ┌─────────────────┐
       │    DuckDB        │
       └──────────────────┘
```

## フェーズ別実装計画

### フェーズ 0: 準備（30分）

**タスク**:
1. 依存関係の追加
2. ディレクトリ構造の整備
3. 基本的な型定義

**ファイル**:
```bash
# 依存関係追加
go get github.com/AlecAivazis/survey/v2
go get github.com/olekukonko/tablewriter
go get github.com/spf13/cobra  # コマンド管理用

# ディレクトリ作成
mkdir -p internal/analyzer
mkdir -p internal/commands
mkdir -p internal/ui
```

**成果物**:
- [ ] go.mod に依存関係が追加されている
- [ ] internal/ ディレクトリ構造ができている
- [ ] internal/analyzer/types.go に基本的な型が定義されている

---

### フェーズ 1: 列の一覧表示（1-2時間）

**目標**: `calcanke columns` で列一覧が表示される

**タスク**:
1. Analyzer の初期化処理
2. GetColumns() の実装
3. columns コマンドの実装

**実装ファイル**:
- `internal/analyzer/analyzer.go` - Analyzer 本体
- `internal/analyzer/columns.go` - 列情報取得
- `internal/commands/columns.go` - columns コマンド
- `cmd/calcanke/main.go` - コマンド登録

**テスト方法**:
```bash
# 実行
calcanke columns

# 期待する出力:
# データベース: data/app.duckdb
# テーブル: excel_import
# 総件数: 19,061件
#
#  1  詳細タイトル名                VARCHAR
#  2  申込人数（受験生）            INTEGER
#  3  申込人数（保護者等）          INTEGER
#  4  性別                          VARCHAR
# ...
```

**成果物**:
- [ ] 列番号付きで一覧が表示される
- [ ] 列のデータ型が表示される
- [ ] エラーハンドリングができている

---

### フェーズ 2: シンプルなクロス集計（2-3時間）

**目標**: 複数回答なしのクロス集計ができる

**タスク**:
1. AnalysisConfig の定義
2. buildSimpleCrosstabQuery() の実装
3. Crosstab() の実装
4. 結果表示（tablewriter）

**実装ファイル**:
- `internal/analyzer/crosstab.go` - クロス集計ロジック
- `internal/analyzer/query_builder.go` - SQL生成
- `internal/ui/display.go` - テーブル表示

**テスト方法**:
```bash
# DuckDB で直接テスト
duckdb data/app.duckdb -c "
SELECT 性別, \"進学にあたり、第一志望は？\", COUNT(*)
FROM excel_import
WHERE 性別 IS NOT NULL AND \"進学にあたり、第一志望は？\" IS NOT NULL
GROUP BY 性別, \"進学にあたり、第一志望は？\"
ORDER BY 性別, COUNT(*) DESC
"
```

**成果物**:
- [ ] 2列のクロス集計が動作する
- [ ] 割合計算が正しい
- [ ] テーブル形式で見やすく表示される

---

### フェーズ 3: 対話型UI（2-3時間）

**目標**: `calcanke analyze` で対話的に操作できる

**タスク**:
1. survey による列選択UI
2. 分析タイプの選択
3. フロー全体の統合

**実装ファイル**:
- `internal/ui/interactive.go` - 対話型UI
- `internal/commands/analyze.go` - analyze コマンド

**テスト方法**:
```bash
calcanke analyze

# 対話的に操作:
# 1. 「クロス集計」を選択
# 2. X軸で「性別」を選択
# 3. Y軸で「進学にあたり、第一志望は？」を選択
# 4. 結果が表示される
```

**成果物**:
- [ ] カーソルで列が選択できる
- [ ] 選択した列が表示される
- [ ] 集計が実行される
- [ ] 直感的に使える

---

### フェーズ 4: 複数回答対応（2-3時間）

**目標**: 改行区切りの複数回答を分割して集計できる

**タスク**:
1. 複数回答の自動判定
2. buildMultiAnswerCrosstabQuery() の実装
3. 分割確認のUI追加

**実装ファイル**:
- `internal/analyzer/multianswer.go` - 複数回答判定
- `internal/analyzer/query_builder.go` - SQL生成（拡張）

**テスト方法**:
```bash
calcanke analyze

# 対話的に操作:
# 1. 「複数回答のクロス集計」を選択
# 2. X軸で「本イベントを何でお知りになりましたか？」を選択
#    → [複数回答] マーカーが表示される
# 3. 「分割しますか？」→ Yes
# 4. Y軸で「第一志望」を選択
# 5. 結果が表示される（情報源が個別にカウントされる）
```

**成果物**:
- [ ] 複数回答列が自動判定される
- [ ] [複数回答] マーカーが表示される
- [ ] 分割の確認ダイアログが表示される
- [ ] 正しく分割・集計される

---

### フェーズ 5: エクスポート機能（1時間）

**目標**: 集計結果をCSVでエクスポートできる

**タスク**:
1. ExportCSV() の実装
2. エクスポート確認UI
3. ファイルパス入力

**成果物**:
- [ ] CSVエクスポートが動作する
- [ ] BOM付きUTF-8で保存される（Excelで文字化けしない）
- [ ] エクスポート完了メッセージが表示される

---

### フェーズ 6: 洗練（1-2時間）

**目標**: ユーザー体験の向上

**タスク**:
1. エラーメッセージの改善
2. ヘルプの追加
3. プログレスバー（集計中）
4. カラー出力

**Optional機能**:
- 検索機能（列名で絞り込み）
- 最近使った列の表示
- 設定ファイル（デフォルトDB等）

---

## 実装順序まとめ

```
フェーズ0: 準備                      [30分]
   ↓
フェーズ1: 列の一覧                   [1-2h]
   ↓
フェーズ2: シンプルなクロス集計        [2-3h]
   ↓
フェーズ3: 対話型UI                   [2-3h]
   ↓
フェーズ4: 複数回答対応               [2-3h]
   ↓
フェーズ5: エクスポート                [1h]
   ↓
フェーズ6: 洗練                       [1-2h]

合計: 10-16時間（2-3日分）
```

## 最初の一歩（推奨）

### ステップ1: フェーズ0 + フェーズ1

最小限で動くものを作る：
1. 依存関係追加
2. 列の一覧表示だけ実装
3. 動作確認

**これだけで使える機能**:
```bash
calcanke columns
# → 列番号と列名が表示される
# → どの列でクロス集計できるか分かる
```

### ステップ2: フェーズ2

手動でクロス集計できるようにする：
```bash
calcanke crosstab --x 性別 --y 進学にあたり、第一志望は？
# → クロス集計結果が表示される
```

これだけでも十分価値がある。

### ステップ3: フェーズ3 以降

対話型UIを追加して、より使いやすくする。

## 質問

1. **どこから始めますか？**
   - A: まずフェーズ0+1（列一覧）だけ作る
   - B: フェーズ0-3まで一気に作る
   - C: 別のアプローチがある

2. **実装を手伝いますか？**
   - コード生成も含めて一緒に実装？
   - 設計だけ確認して、実装は自分でやる？

3. **優先したい機能は？**
   - とにかく早く動くもの
   - 丁寧なエラーハンドリング
   - きれいなUI

どうしますか？
